Геосервис, принимающий запросы на нахождение маршрутов,
реализованный на Python как wsgi приложение.

# Требования
* ОС Ubuntu 14.04 и выше
* Веб-сервер Apache 2.4
* Python 2.7.xx - обычно уже установлен в системе

# Состав
* каталог html - frontend, веб приложение для тестирования и визуализации
* каталог wsgi_app - сам сервис приложения
* каталог doc - содержит подробную инструкцию по настройке и необходимые для этого компоненты 

# Установка
1. Установить mod_wsgi

        sudo apt-get install -y libapache2-mod-wsgi
        sudo a2enmod, вводим wsgi
        sudo service apache2 restart
2. Установить spatialite
        
        sudo apt-get install python-pyspatialite
3. Настройка виртуального хоста

    В каталоге /etc/apache2/sites-enabled создаем файл конфигурации для виртуального хоста, 
    например py_spa.conf. Расширение "conf" обязательно.
    
    Пример содержания этого файла у меня:

        <VirtualHost *:8080>
    
        ServerName geoserver.py
        ServerAdmin webmaster@example.com
    
        DocumentRoot /home/user1/www/geoservice_python/html
            ErrorLog ${APACHE_LOG_DIR}/error.log
        <Directory /home/user1/www/geoservice_python/html>
        Order allow,deny
        Allow from all
        </Directory>
    
            #use "production" for production
            SetEnv ENV dev
    
            WSGIScriptAlias /route /home/user1/www/geoservice_python/wsgi_app/route.py
            WSGIScriptAlias /nearest /home/user1/www/geoservice_python/wsgi_app/nearest.py
            WSGIScriptAlias /incity /home/user1/www/geoservice_python/wsgi_app/incity.py
            WSGIScriptAlias /land /home/user1/www/geoservice_python/wsgi_app/land.py
            WSGIScriptAlias /water /home/user1/www/geoservice_python/wsgi_app/water.py
            WSGIScriptAlias /route_railway /home/user1/www/geoservice_python/wsgi_app/route_railway.py
            WSGIScriptAlias /nearest_railway /home/user1/www/geoservice_python/wsgi_app/nearest_railway.py
    
            WSGIDaemonProcess geoserver.py processes=2 threads=15 display-name=%{GROUP}
        WSGIProcessGroup geoserver.py
        </VirtualHost>
    
    Пояснения:
    * Директива  DocumentRoot /home/user1/www/geoservice_python/html должна указывать на каталог html
    
    * В директиве WSGIScriptAlias /route /home/user1/www/geoservice_python/wsgi_app/route.wsgi
    указывается URL при обращении по которому Apache будет вызывать wsgi приложение и путь к этому приложению
    Таких директив может быть не одна.
			
4. перезапускаем веб-сервер	sudo service apache2 restart
5. для обращения к веб приложению через браузер добавляем в /etc/hosts строку 127.0.0.1	geoserver.py
6. Скачать готовую базу данных отсюда
        
        https://yadi.sk/d/_HLV582ZTXaVww
    или собрать бд из OSM-файлов следую инструкции в doc/README.md
		
# Использование
В файлах route.py и nearest.py  переменной DB_DIR присваиваем путь до каталога с базами данных SQLite(spatialite), в которых
содержатся графы дорожных сетей.

Открываем в браузере адрес указанный в ServerName, например, в моем случае http://geoserver.py
Откроется веб-приложение. Интерфейс состоит из карты, выпадающего списка с регионами, радио-кнопкой
"маршрутизация, ближайший узел", поля в которое выводится время выполнения запроса.
При первом клике ставится маркер, при втором ставится второй маркер и отображается маршрут. При третьем клике
возвращение в исходное. При перетаскивании маркера - перепостроение маршрута.
При переключении на "ближайший узел" ставится маркер в месте клика и в месте расположения ближайшего узла графа дорожной сети.

# API
* Запрос на поиск маршрута
GET http://server.name/route?data=lat_source,lng_source,lat_target,lng_target,db_filename
    
    Пример: 
        
        http://geoserver.py/route?data=56.62,47.728765,55.83,48.36,RU-ME.osm.sqlite

    Пример ответа(сокращен):
        
        {"type":"LineString","coordinates":[[47.7301384,56.6167473], [47.73038019999999,56.6162736],[47.731074,56.61590629999999],[47.73520959999999,56.61613409999999]...]}
	
* Запрос на поиск ближайшего узла
GET http://server.name/nearest?data=lat_point,lng_point,db_filename
		
	Пример: 
		    
	    http://geoserver.py/nearest?data=56.62,47.728765,RU-ME.osm.sqlite
		
	Пример ответа: 
	 
	    {"type":"Point","coordinates":[47.7301384,56.6167473]}
		
* Запрос на принадлежность точки городу:
GET http://server.name/incity?data=lat_point,lng_point,db_filename
Пример ответа:

        {"incity":true,"city_name":"Ioshkar-Ola","city_lastname":"Йошкар-Ола","city_geometry":
        {"type":"Polygon","coordinates":[[[47.816963195800774,56.61638739807571],
        [47.80220031738281,56.62696490843875],[47.770957946777344,56.6331966963466],
        [47.77576446533203,56.64225927813471],[47.804603576660156,56.64131536077352],
        [47.823829650878906,56.65037599240433],[47.838592529296875,56.66169872107921],
        [47.88047790527344,56.66886802376446],[47.905540466308594,56.65905705522496],
        [47.92133331298828,56.65264081020062],[47.929573059082024,56.646789752671125],
        [47.948455810546875,56.653584444132846],[47.97008514404297,56.65849095988349],
        [47.980728149414055,56.652829538876446],[47.990684509277344,56.64811103856809],
        [48.00098419189453,56.64018262875998],[48.01540374755859,56.63187488793702],
        [48.020896911621094,56.6267760503155],[47.99274444580078,56.619032053538],
        [47.96424865722656,56.626020608371924],[47.936439514160156,56.617520844529714],
        [47.923736572265625,56.61336470784085],[47.917213439941406,56.60448415579752],
        [47.889747619628906,56.60807441765139],[47.88013458251953,56.59957061284579],
        [47.83824920654297,56.611097531363896],[47.81576156616211,56.61015283432441]]]}}
        
* Запрос на принадлежность точки объекту ландшафта:
GET http://server.name/land?data=lat_point,lng_point
Пример ответа:

        {"res":true,"name":"Авіант","sub_type":"industrial","geometry":{"type":"MultiPolygon",
        "coordinates":[[[[30.4405614,50.3051783],[30.4404326,50.30445189999999],[30.4408977,50.3040497],
        [30.441763,50.3040613],[30.4425677,50.303986],[30.44306119999999,50.30382149999999],
        [30.4440053,50.30379409999999],[30.44858659999999,50.3027182],[30.4495736,50.3025126],
        [30.4515622,50.30161689999999],[30.4518412,50.30151409999999],[30.45279599999999,50.3023022],
        [30.45331799999999,50.3025674],[30.4526313,50.30301289999999],[30.45151549999999,50.30354739999999],
        [30.4510542,50.303705],[30.4452284,50.3045205],[30.4405614,50.3051783]]]]},
        "country":"ukraine","id":2596,"avg_lat":50.3033462,"avg_lng":30.4468753}
         

* Запрос на поиск рек между двумя точками:
GET http://server.name/water?data=lat_point1,lng_point1,lat_point2,lng_point2
Пример ответа:

      {"res":true,"waters":{"18220":{"geometry":{"type":"MultiLineString","coordinates":[[[30.3911444,50.20313809999999],[30.3916943,50.2034603],
      [30.3940975,50.20378989999999],[30.3952992,50.20381739999999],[30.3978955,50.20385859999999],[30.39890409999999,50.2036388],[30.40068499999999,50.20302079999999],
      [30.4020154,50.2024989],[30.4033887,50.2021418],[30.40469759999999,50.2020319],[30.40514819999999,50.20204559999999],[30.4055345,50.20194949999999],
      [30.4097154,50.2015327],[30.4100052,50.20150379999999],[30.41162849999999,50.20108419999999]]]},"width":-1,"id":18220,"country":"ukraine"},
      "36899":{"geometry":{"type":"MultiLineString","coordinates":[[[30.3927777,50.2254105],[30.39281289999999,50.22533719999999],[30.3930167,50.2252171],
      [30.3932688,50.22512439999999],[30.3933922,50.22505919999999],[30.3935585,50.2250626],[30.3937302,50.2249665],[30.3938321,50.2248601],
      [30.39405599999999,50.22474789999999],[30.39427549999999,50.224701],[30.39427549999999,50.2246126],[30.39447059999999,50.22451379999999],
      [30.39488529999999,50.2243317],[30.39568209999999,50.2240248],[30.39616189999999,50.22381149999999],[30.3972596,50.223671],[30.39766609999999,50.22349419999999],
      [30.39847109999999,50.2232757],[30.3990158,50.22303639999999],[30.399398,50.2228179],[30.40008909999999,50.2224069],[30.4007559,50.22194389999999],
      [30.40139819999999,50.2214965],[30.4019267,50.2211635],[30.4025609,50.2208618],[30.40340649999999,50.2205809],[30.4042765,50.2203676],[30.4066771,50.219794],
      [30.4088289,50.2193411],[30.4108817,50.2190421],[30.4126371,50.2184352],[30.4141094,50.21785549999999],[30.4157532,50.2173535],[30.4178454,50.21670799999999],
      [30.4182937,50.2162657],[30.41907829999999,50.21596689999999],[30.4208716,50.2152736],[30.4224967,50.21438909999999],[30.4226648,50.2138392],
      [30.42242879999999,50.2129466],[30.42187089999999,50.21161469999999],[30.4209268,50.2103788],[30.4204547,50.2097059],[30.4195964,50.20893689999999],
      [30.4186093,50.20779699999999],[30.4176223,50.2068632],[30.4166567,50.2058606],[30.41494009999999,50.2056272],[30.41257969999999,50.205531],
      [30.4111206,50.2049954],[30.4104983,50.2046933],[30.40974729999999,50.2039654],[30.40923229999999,50.20327869999999],[30.40908209999999,50.20281169999999],
      [30.40908209999999,50.2025233],[30.4091251,50.20227609999999],[30.40933959999999,50.2019602],[30.4095327,50.20185029999999],[30.4097154,50.2015327]]]},
      "width":-1,"id":36899,"country":"ukraine"}}}
		
## Дополнения:
В связи с добавлением поддержки сетки в запросы (маршрута и ближайшего узла) в конце должен быть добавлен еще параметр "scale".
Величина scale равна 2**m, где m - параметр m в команде start_mkgrid.py
	
т.е. если

	./start_mkgrid.py -u -d /home/user1/game1/db -m 2
	
то:
	
    http://server.name/route?data=lat_source,lng_source,lat_target,lng_target,db_filename,4
    http://server.name/nearest?data=lat_point,lng_point,db_filename,4
	
	
		
		
	
	
